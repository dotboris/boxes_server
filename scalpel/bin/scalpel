#!/usr/bin/env ruby
$:.unshift File.expand_path('../../lib', __FILE__)
require 'boxes'
require 'scalpel'

puts 'Scalpel reporting in!'

conn = Boxes.bunny
conn.start

ch = conn.create_channel
q = ch.queue 'boxes.uncut'

q.subscribe block: true do |_, _, body|
  begin
    puts 'Got a message'
    order = Scalpel::Order.from_json body
    puts "order: #{order.inspect}"

    slices = Scalpel.split_image order.image, order.rows, order.columns

    split_image = Boxes::SplitImage.create! Boxes.media_root
    split_image.slices = slices
    split_image.original = order.image
    split_image.row_count = order.rows

    puts "split image: #{split_image.inspect}"

    split_image.save!
    puts 'Saved split image'

    split_image.activate!
    puts 'Activated split image'
  rescue => e
    puts "Failed to respond to request #{e}"
    puts e.backtrace
  end
end
